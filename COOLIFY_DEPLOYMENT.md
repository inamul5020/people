# Coolify Deployment Guide

This guide explains how to deploy the Demographic Search App to Coolify using the `docker-compose.coolify.yml` file.

## Prerequisites

- Coolify instance set up and running
- Git repository with the application code
- Access to Coolify dashboard

## Deployment Steps

### 1. Create New Application in Coolify

1. Go to your Coolify dashboard
2. Click "New Resource" â†’ "New Application"
3. Select "Docker Compose" as the deployment method
4. Connect your Git repository or upload the code

### 2. Configure Docker Compose

1. In the application settings, set the **Docker Compose File** to: `docker-compose.coolify.yml`
2. Coolify will automatically detect the services from the compose file

### 3. Set Environment Variables

In Coolify, set the following environment variables:

#### Database Variables (for PostgreSQL service)
- `POSTGRES_DB`: Database name (default: `demographic_db`)
- `POSTGRES_USER`: Database user (default: `postgres`)
- `POSTGRES_PASSWORD`: **Set a strong password** (required)

#### Application Variables (for app service)
- `DATABASE_URL`: Usually auto-generated by Coolify, but you can set it manually:
  ```
  postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
  ```
- `NODE_ENV`: `production` (default)
- `PORT`: Port number (Coolify usually sets this automatically, default: `3000`)
- `ADMIN_USERNAME`: Admin username (default: `admin`)
- `ADMIN_PASSWORD`: **Set a strong password** (default: `admin786@@@`)
- `SESSION_SECRET`: **Set a strong random secret** for session encryption

### 4. Deploy the Application

1. Click "Deploy" in Coolify
2. Wait for the build to complete
3. Monitor the logs for any errors

### 5. Initialize the Database

After the first deployment, you need to initialize the database schema and create the admin user.

#### Option A: Using Coolify Terminal

1. Go to your application in Coolify
2. Click on the "Terminal" tab
3. Run the following commands:

```bash
# Copy initialization script to container
docker cp scripts/init-database.js <container-name>:/tmp/init-db.js
docker cp database <container-name>:/tmp/database

# Run initialization (adjust paths as needed)
cd /app
NODE_PATH=/app/node_modules:$NODE_PATH node /tmp/init-db.js
```

#### Option B: Using SQL Files Directly

1. Connect to the PostgreSQL container via terminal
2. Run the SQL files:

```bash
# Connect to postgres container
docker exec -it demographic-search-db psql -U postgres -d demographic_db

# Or use psql directly if available
psql $DATABASE_URL -f database/schema.sql
psql $DATABASE_URL -f database/admin_users.sql
```

3. Create admin user using the setup script or manually insert with bcrypt hash

#### Option C: Manual SQL Execution

Execute the SQL files from the `database/` directory using any PostgreSQL client or Coolify's database management interface.

### 6. Access the Application

1. Coolify will provide you with a URL (e.g., `https://people.kebazz.com`)
2. Access the application in your browser
3. Login with:
   - Username: `admin` (or your `ADMIN_USERNAME`)
   - Password: Your `ADMIN_PASSWORD`

## Service Configuration

### PostgreSQL Service
- **Container Name**: `demographic-search-db`
- **Image**: `postgres:15-alpine`
- **Port**: `5432` (internal only, exposed to app service)
- **Healthcheck**: Checks database readiness every 15 seconds

### Application Service
- **Container Name**: `demographic-search-app`
- **Port**: Set by Coolify (default: `3000`)
- **Healthcheck**: `/api/auth/check`
- **Depends on**: PostgreSQL service (waits for healthcheck)

## Troubleshooting

### Database Connection Issues

If the app can't connect to the database:

1. Check that `DATABASE_URL` environment variable is correctly set
2. Verify PostgreSQL service is healthy (check healthcheck status)
3. Ensure the database credentials match between services
4. Check application logs for connection errors

### Port Issues

If the application doesn't start:

1. Verify `PORT` environment variable is set correctly
2. Check that Coolify has assigned a port
3. Review application logs for port binding errors

### Build Failures

If the Docker build fails:

1. Check build logs in Coolify
2. Verify all dependencies are in `package.json`
3. Ensure `Dockerfile` is correctly configured
4. Check for TypeScript compilation errors

### Database Initialization

If database initialization fails:

1. Verify SQL files are accessible in the container
2. Check that PostgreSQL is ready (healthcheck passed)
3. Ensure `bcrypt` module is available for admin user creation
4. Check database logs for SQL errors

## Environment Variables Reference

| Variable | Description | Default | Required |
|----------|-------------|---------|----------|
| `POSTGRES_DB` | PostgreSQL database name | `demographic_db` | No |
| `POSTGRES_USER` | PostgreSQL username | `postgres` | No |
| `POSTGRES_PASSWORD` | PostgreSQL password | `postgres` | **Yes** |
| `DATABASE_URL` | Full database connection string | Auto-generated | No |
| `NODE_ENV` | Node environment | `production` | No |
| `PORT` | Application port | `3000` | No (set by Coolify) |
| `ADMIN_USERNAME` | Admin login username | `admin` | No |
| `ADMIN_PASSWORD` | Admin login password | `admin786@@@` | **Yes** |
| `SESSION_SECRET` | Session encryption secret | `change-this...` | **Yes** |

## Notes

- The `docker-compose.coolify.yml` uses `expose` instead of `ports` because Coolify handles port mapping automatically
- Healthchecks are configured to ensure services start in the correct order
- The PostgreSQL service is only accessible internally within the Docker network
- All services are labeled with `coolify.managed=true` for proper Coolify integration

## Security Recommendations

1. **Always change default passwords** in production:
   - `POSTGRES_PASSWORD`
   - `ADMIN_PASSWORD`
   - `SESSION_SECRET`

2. Use strong, randomly generated secrets for `SESSION_SECRET`

3. Consider using Coolify's built-in secrets management for sensitive values

4. Enable SSL/TLS for database connections in production if possible

5. Regularly update dependencies and base images

## Support

For issues specific to Coolify, refer to [Coolify Documentation](https://coolify.io/docs).

For application-specific issues, check the application logs in Coolify's dashboard.

